# 本地 Shapefile 分析使用指南

本应用支持完全在浏览器中加载和分析本地 Shapefile 数据，无需服务器端处理。

## 支持的数据格式

### 方式 1：ZIP 文件（推荐）
将 Shapefile 的所有组件打包成 ZIP 文件：
- 必须包含：`.shp` 文件
- 推荐包含：`.dbf` 文件（属性数据）
- 可选：`.shx`, `.prj`, `.cpg` 等其他文件

### 方式 2：单独文件
分别上传：
- `.shp` 文件（必需）
- `.dbf` 文件（可选）

## 使用步骤

### 1. 上传 Shapefile

点击顶部或底部的 **"上传 SHP"** 或 **"上传 Shapefile"** 按钮。

在弹出的对话框中：
- **方式 1（推荐）**: 选择 ZIP 文件
- **方式 2**: 分别选择 .shp 和 .dbf 文件

点击 **"加载"** 按钮。

### 2. 查看数据

上传成功后：
- 数据会自动显示在地图上（蓝色线条）
- 地图会自动缩放到数据范围
- 控制台会显示：`成功加载 N 个要素`

### 3. 执行空间分析

数据加载后会自动弹出空间分析对话框，或手动点击 **"空间分析"** 按钮。

在对话框中：
1. **数据源**: 选择 "本地数据 (N 个要素)"
2. **分析类型**: 
   - 连接度 (Connectivity): 计算每条线与其他线的交叉数量
   - 整合度 (Integration): 计算空间句法整合度值
3. **整合度模式**:
   - 拓扑深度：简单的拓扑距离（每跨越一条线+1）
   - 角度+长度加权：考虑转角和线段长度的加权距离（更精确）
4. **颜色拉伸**（可选）: 手动设置颜色范围的最小值和最大值

点击 **"开始分析"**。

### 4. 查看结果

分析完成后：
- 线条会根据分析结果着色（蓝色=低值，红色=高值）
- 点击任意线条可查看其详细数值
- 控制台会显示分析统计信息

### 5. 清除结果

点击 **"清除分析"** 按钮可移除分析结果图层。

## 性能优化

### WASM 加速

应用自动使用 WebAssembly 加速计算：
- 需先编译 WASM 模块（见 `wasm_modules/README.md`）
- 如果 WASM 不可用，自动回退到 JavaScript 实现
- WASM 提供 5-20x 性能提升

检查是否使用 WASM：
1. 打开浏览器开发者工具（F12）
2. 查看控制台
3. 如果看到 `✓ WASM 加速已启用`，说明 WASM 正在工作

### 数据集大小建议

| 要素数量 | 推荐配置 | 预计时间 |
|---------|---------|---------|
| < 100 | JavaScript 即可 | < 1秒 |
| 100-500 | 推荐使用 WASM | 1-5秒 |
| 500-1000 | 需要 WASM | 5-15秒 |
| 1000-5000 | 必须使用 WASM | 15-60秒 |
| > 5000 | 必须使用 WASM | > 1分钟 |

## 坐标系统

- **输入**: Shapefile 应使用 WGS84 (EPSG:4326) 坐标系统
- **显示**: 自动转换到百度地图投影 (BD-09)
- 如果 Shapefile 使用其他坐标系统，可能需要预先转换

## 浏览器兼容性

| 浏览器 | 最低版本 | WASM 支持 |
|--------|---------|----------|
| Chrome | 57+ | ✓ |
| Firefox | 52+ | ✓ |
| Safari | 11+ | ✓ |
| Edge | 16+ | ✓ |

## 常见问题

### Q: 上传后没有显示数据？
**A**: 检查：
1. Shapefile 是否包含线要素（LineString 或 MultiLineString）
2. 坐标系统是否正确（应为地理坐标）
3. 浏览器控制台是否有错误信息

### Q: 分析速度很慢？
**A**: 
1. 检查是否启用了 WASM（控制台查看）
2. 尝试减少要素数量（预处理数据）
3. 使用"拓扑深度"模式而不是"角度+长度加权"

### Q: 分析结果不正确？
**A**: 
1. 确认 Shapefile 的拓扑关系正确（线段在交叉处相连）
2. 检查坐标系统是否正确
3. 尝试不同的分析模式

### Q: 浏览器崩溃或内存不足？
**A**: 
1. 数据集可能太大（> 10000 要素）
2. 尝试简化或切分数据
3. 使用更强大的计算机
4. 增加浏览器内存限制

## 数据隐私

- **完全本地处理**: 所有数据在浏览器中处理，不上传到服务器
- **无网络传输**: Shapefile 不会发送到任何远程服务器
- **内存临时存储**: 数据仅存储在浏览器内存中，刷新页面即清除

## 技术细节

### 使用的库

- **shapefile.js**: 客户端 Shapefile 解析（MIT 许可）
- **JSZip**: ZIP 文件解压（MIT 许可）
- **OpenLayers**: 地图显示（BSD 许可）
- **WebAssembly**: 高性能计算加速

### 计算原理

#### 连接度（Connectivity）
计算每条线段与多少其他线段相交。值越高表示该线段连接了更多道路。

#### 整合度（Integration）
基于空间句法理论，计算从该线段到所有其他线段的平均深度。值越高表示该线段在路网中越"中心"。

公式：
- **拓扑模式**: depth = 跳数（每跨越一条线+1）
- **加权模式**: depth = Σ(angle_weight * length_weight)
  - angle_weight = (1 + bin) * 0.5，其中 bin = floor(angle / (180 / tulip_bins))
  - length_weight = length * 0.001

## 示例数据

可以使用以下类型的 Shapefile 进行测试：
- 道路网络
- 河流系统
- 建筑轮廓线
- 任何线状地理要素

确保数据：
1. 使用 WGS84 坐标系统
2. 包含 LineString 或 MultiLineString 几何类型
3. 拓扑关系正确（相交的线在交点处相连）
